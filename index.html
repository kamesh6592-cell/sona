<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Secure Hierarchical Communication Platform for Sona College of Technology">
    <meta name="theme-color" content="#1E3A8A">
    
    <!-- Favicon -->
    <link rel="icon" href="https://upload.wikimedia.org/wikipedia/commons/9/9d/Sona_College_of_Technology_logo.jpg" type="image/jpeg">
    <link rel="apple-touch-icon" href="https://upload.wikimedia.org/wikipedia/commons/9/9d/Sona_College_of_Technology_logo.jpg">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiU29uYSBDb21tdW5pY2F0aW9uIiwic2hvcnRfbmFtZSI6IlNvbmFDb21tIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiMwYTE5MmYiLCJ0aGVtZV9jb2xvciI6IiMxRTNBOEEiLCJvcmllbnRhdGlvbiI6InBvcnRyYWl0In0=">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Sona Communication">
    
    <title>Sona College of Technology - Communication Platform</title>
    
    <!-- Preconnect to external domains for performance -->
    <link rel="preconnect" href="https://rsms.me/">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    
    <!-- CSS -->
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/tonsky/FiraCode@4/distr/fira_code.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    
    <!-- JavaScript -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    
    <style>
        /* CSS Variables for theming */
        :root {
            --primary-blue: #0a192f;
            --secondary-blue: #172a45;
            --accent-blue: #233554;
            --primary-yellow: #f1c40f;
            --secondary-yellow: #f9e79f;
            --accent-yellow: #ffd700;
            --text-primary: #ffffff;
            --text-secondary: #a8b2d1;
            --text-muted: #64748b;
            --success: #4ade80;
            --warning: #f59e0b;
            --error: #ef4444;
            --info: #3b82f6;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --font-family: 'Inter', sans-serif;
            --mono-font: 'Fira Code', monospace;
            --card-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6 rgba(0, 0, 0, 0.1);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --border-radius: 16px;
            --input-padding: 1rem;
            --button-padding: 1rem 1.5rem;
        }

        /* Base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-family);
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            position: relative;
        }

        /* Background pattern */
        .background-pattern {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(255, 255, 255, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(255, 255, 255, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.03) 0%, transparent 50%);
            z-index: -1;
        }

        /* Header */
        .header {
            background: rgba(10, 25, 47, 0.95);
            backdrop-filter: blur(10px);
            padding: 1.5rem 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 100;
            border-bottom: 1px solid var(--glass-border);
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 1.25rem;
        }

        .logo {
            height: 60px;
            width: auto;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
            transition: var(--transition);
        }

        .logo:hover {
            transform: scale(1.05);
        }

        .logo-text {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            background: linear-gradient(90deg, var(--primary-yellow), var(--accent-yellow));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Main container */
        .main-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        .login-container {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 3rem;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            width: 100%;
            max-width: 500px;
            animation: fadeInUp 0.6s ease-out;
            position: relative;
            overflow: hidden;
            border: 1px solid var(--glass-border);
        }

        .login-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, var(--primary-yellow), var(--accent-yellow));
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        /* Logo and title */
        .app-title {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 2.5rem;
        }

        h1 {
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            background: linear-gradient(90deg, var(--primary-yellow), var(--accent-yellow));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 1.125rem;
            color: var(--text-secondary);
            text-align: center;
        }

        /* Form styles */
        .form-group {
            margin-bottom: 1.75rem;
            position: relative;
        }

        label {
            display: block;
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
            transition: var(--transition);
        }

        .input-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        .input-icon {
            position: absolute;
            left: 1.25rem;
            color: var(--text-secondary);
            z-index: 1;
            transition: var(--transition);
        }

        input, select {
            width: 100%;
            padding: var(--input-padding);
            padding-left: 3.5rem;
            border: 2px solid var(--glass-border);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            background: var(--glass-bg);
            color: var(--text-primary);
            font-family: var(--font-family);
        }

        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23a8b2d1' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1.25rem center;
            background-size: 1rem;
        }

        input:focus, select:focus {
            border-color: var(--primary-yellow);
            box-shadow: 0 0 0 3px rgba(241, 196, 15, 0.15);
            outline: none;
        }

        input:focus + .input-icon, select:focus + .input-icon {
            color: var(--primary-yellow);
        }

        .password-toggle {
            position: absolute;
            right: 1.25rem;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            padding: 0.5rem;
            border-radius: 8px;
        }

        .password-toggle:hover {
            color: var(--text-primary);
            background: var(--glass-bg);
        }

        /* Form options */
        .form-options {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 1.75rem 0;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
        }

        .checkbox-group input {
            width: auto;
            margin-right: 0.75rem;
            accent-color: var(--primary-yellow);
        }

        .checkbox-group label {
            margin-bottom: 0;
            font-size: 0.875rem;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .forgot-link {
            font-size: 0.875rem;
            color: var(--info);
            text-decoration: none;
            transition: var(--transition);
            font-weight: 600;
        }

        .forgot-link:hover {
            color: var(--primary-yellow);
            text-decoration: underline;
        }

        /* Buttons */
        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: var(--button-padding);
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            margin-bottom: 1rem;
            gap: 0.75rem;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-yellow) 0%, var(--accent-yellow) 100%);
            color: var(--primary-blue);
            box-shadow: 0 4px 15px rgba(241, 196, 15, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(241, 196, 15, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-microsoft {
            background: var(--info);
            color: var(--white);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .btn-microsoft:hover {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }

        .btn-google {
            background: #ea4335;
            color: var(--white);
            box-shadow: 0 4px 15px rgba(234, 67, 53, 0.3);
        }

        .btn-google:hover {
            background: #d33b2c;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(234, 67, 53, 0.4);
        }

        .btn-loading .btn-text {
            visibility: hidden;
            opacity: 0;
        }

        .btn-loading::after {
            content: "";
            position: absolute;
            width: 20px;
            height: 20px;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            margin: auto;
            border: 2px solid transparent;
            border-top-color: var(--white);
            border-radius: 50%;
            animation: button-loading-spinner 1s ease infinite;
        }

        @keyframes button-loading-spinner {
            from { transform: rotate(0turn); }
            to { transform: rotate(1turn); }
        }

        /* Divider */
        .divider {
            display: flex;
            align-items: center;
            margin: 2rem 0;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .divider::before,
        .divider::after {
            content: "";
            flex: 1;
            height: 1px;
            background: var(--glass-border);
        }

        .divider span {
            padding: 0 1.5rem;
        }

        /* Role badges */
        .role-badges {
            display: flex;
            gap: 1rem;
            margin-top: 1.25rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .role-badge {
            padding: 0.75rem 1.25rem;
            border-radius: 30px;
            font-size: 0.875rem;
            font-weight: 600;
            background: var(--glass-bg);
            color: var(--text-secondary);
            transition: var(--transition);
            cursor: pointer;
            user-select: none;
            border: 1px solid var(--glass-border);
            position: relative;
            overflow: hidden;
        }

        .role-badge::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, var(--primary-yellow), var(--accent-yellow));
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
        }

        .role-badge:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--primary-yellow);
            transform: translateY(-2px);
        }

        .role-badge.active {
            background: var(--primary-yellow);
            color: var(--primary-blue);
            border-color: var(--primary-yellow);
            box-shadow: 0 4px 10px rgba(241, 196, 15, 0.3);
        }

        .role-badge.active::before {
            opacity: 1;
        }

        .role-student.active {
            background: linear-gradient(135deg, #4ade80, #22c55e);
        }

        .role-faculty.active {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .role-hod.active {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }

        .role-principal.active {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        /* Register link */
        .register-link {
            text-align: center;
            margin-top: 2rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .register-link a {
            color: var(--info);
            text-decoration: none;
            font-weight: 600;
            transition: var(--transition);
        }

        .register-link a:hover {
            color: var(--primary-yellow);
            text-decoration: underline;
        }

        /* Security notice */
        .security-notice {
            margin-top: 2rem;
            padding: 1.25rem;
            background: rgba(241, 196, 15, 0.1);
            border-radius: var(--border-radius);
            font-size: 0.875rem;
            color: var(--text-primary);
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            border-left: 4px solid var(--primary-yellow);
        }

        /* Modal styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
            padding: 1rem;
        }

        .modal-content {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 3rem;
            border-radius: var(--border-radius);
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: modalFadeIn 0.3s ease-out;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--glass-border);
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.9) translateY(-20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .close-btn {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            background: none;
            border: none;
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .close-btn:hover {
            color: var(--text-primary);
            background: var(--glass-bg);
        }

        .modal h2 {
            margin-bottom: 1.75rem;
            color: var(--primary-yellow);
            font-size: 1.75rem;
        }

        /* Password strength */
        .password-strength {
            margin-top: 0.75rem;
            height: 4px;
            border-radius: 2px;
            background: var(--glass-border);
            overflow: hidden;
        }

        .password-strength-bar {
            height: 100%;
            width: 0%;
            transition: var(--transition);
        }

        .password-strength.weak .password-strength-bar {
            width: 33%;
            background: var(--error);
        }

        .password-strength.medium .password-strength-bar {
            width: 66%;
            background: var(--warning);
        }

        .password-strength.strong .password-strength-bar {
            width: 100%;
            background: var(--success);
        }

        .password-strength-text {
            font-size: 0.75rem;
            margin-top: 0.5rem;
            color: var(--text-secondary);
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            padding: 1.25rem 1.75rem;
            border-radius: var(--border-radius);
            color: var(--white);
            font-weight: 600;
            box-shadow: var(--card-shadow);
            z-index: 1100;
            transform: translateX(150%);
            transition: transform 0.3s ease;
            max-width: 90%;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: var(--success);
        }

        .notification.error {
            background: var(--error);
        }

        .notification.info {
            background: var(--info);
        }

        /* Tooltip */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: var(--secondary-blue);
            color: var(--white);
            text-align: center;
            border-radius: 6px;
            padding: 0.5rem;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.75rem;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Footer */
        .footer {
            background: rgba(10, 25, 47, 0.95);
            backdrop-filter: blur(10px);
            padding: 2rem;
            text-align: center;
            color: var(--text-secondary);
            border-top: 1px solid var(--glass-border);
            font-size: 0.875rem;
        }

        .footer-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
        }

        .footer-heart {
            color: #e74c3c;
            animation: heartbeat 1.2s infinite;
        }

        @keyframes heartbeat {
            0% { transform: scale(1); }
            25% { transform: scale(1.1); }
            50% { transform: scale(1); }
            75% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Debug panel */
        .debug-panel {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-width: 300px;
            z-index: 10000;
            display: none;
        }

        .debug-panel.show {
            display: block;
        }

        /* Sync button */
        .sync-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            background: linear-gradient(135deg, var(--info), #2563eb);
            color: white;
            border: none;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
            transition: var(--transition);
            z-index: 999;
            display: none;
            align-items: center;
            gap: 8px;
        }

        .sync-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }

        .sync-button.show {
            display: flex;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            html {
                font-size: 14px;
            }
            
            .header {
                padding: 1rem;
            }
            
            .logo-text {
                font-size: 1.25rem;
            }
            
            .login-container {
                padding: 2rem 1.5rem;
            }
            
            .modal-content {
                padding: 2rem 1.5rem;
            }
            
            .form-options {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .notification {
                right: 0.75rem;
                left: 0.75rem;
                max-width: none;
            }
            
            .sync-button {
                bottom: 10px;
                right: 10px;
                padding: 10px 15px;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            html {
                font-size: 13px;
            }
            
            .header {
                padding: 0.75rem;
            }
            
            .logo {
                height: 50px;
            }
            
            .logo-text {
                font-size: 1rem;
            }
            
            .login-container {
                padding: 1.75rem 1.25rem;
            }
            
            .modal-content {
                padding: 1.75rem 1.25rem;
            }
            
            h1 {
                font-size: 1.75rem;
            }
            
            .btn {
                padding: 0.875rem 1.25rem;
            }
        }

        @media (max-width: 320px) {
            html {
                font-size: 12px;
            }
            
            .header {
                padding: 0.5rem;
            }
            
            .logo {
                height: 40px;
            }
            
            .logo-text {
                font-size: 0.9rem;
            }
            
            .login-container {
                padding: 1.5rem 1rem;
            }
            
            .modal-content {
                padding: 1.5rem 1rem;
            }
            
            .role-badges {
                gap: 0.5rem;
            }
            
            .role-badge {
                padding: 0.5rem 1rem;
                font-size: 0.75rem;
            }
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            :root {
                --primary-blue: #000080;
                --secondary-blue: #0066CC;
                --primary-yellow: #FF8C00;
                --secondary-yellow: #FFF8DC;
                --glass-bg: rgba(255, 255, 255, 0.1);
                --glass-border: rgba(255, 255, 255, 0.3);
                --text-secondary: #E0E0E0;
                --text-muted: #B0B0B0;
            }
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Print styles */
        @media print {
            body {
                background: none;
                padding: 0;
            }
            
            .login-container {
                box-shadow: none;
                max-width: 100%;
            }
        }

        /* Accessibility improvements */
        :focus-visible {
            outline: 2px solid var(--primary-yellow);
            outline-offset: 2px;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--secondary-blue);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-yellow);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-yellow);
        }
    </style>
</head>
<body>
    <div class="background-pattern"></div>
    
    <!-- Header -->
    <header class="header">
        <div class="logo-container">
            <img src="https://upload.wikimedia.org/wikipedia/commons/9/9d/Sona_College_of_Technology_logo.jpg" alt="Sona College of Technology Logo" class="logo">
            <span class="logo-text">Sona College of Technology</span>
        </div>
    </header>
    
    <!-- Main Container -->
    <div class="main-container">
        <div class="login-container">
            <div class="app-title">
                <h1>Communication Platform</h1>
                <p class="subtitle">Secure Hierarchical Communication System</p>
            </div>
            
            <form id="loginForm" aria-label="Login form">
                <div class="form-group">
                    <label for="collegeId">College ID</label>
                    <div class="input-container">
                        <i class="fas fa-user input-icon" aria-hidden="true"></i>
                        <input type="text" id="collegeId" required aria-required="true" placeholder="Enter your College ID" autocomplete="username">
                    </div>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <div class="input-container">
                        <i class="fas fa-lock input-icon" aria-hidden="true"></i>
                        <input type="password" id="password" required aria-required="true" placeholder="Enter your password" autocomplete="current-password">
                        <button type="button" class="password-toggle tooltip" id="passwordToggle" aria-label="Toggle password visibility">
                            <i class="fas fa-eye" aria-hidden="true"></i>
                            <span class="tooltiptext">Toggle password visibility</span>
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="role">Role</label>
                    <div class="input-container">
                        <i class="fas fa-user-tag input-icon" aria-hidden="true"></i>
                        <select id="role" required aria-required="true">
                            <option value="">Select Your Role</option>
                            <option value="student">Student</option>
                            <option value="faculty">Faculty</option>
                            <option value="hod">Head of Department</option>
                            <option value="principal">Principal</option>
                        </select>
                    </div>
                </div>
                
                <div class="role-badges" role="group" aria-label="Role selection">
                    <button type="button" class="role-badge role-student" data-role="student" aria-pressed="false">
                        <i class="fas fa-graduation-cap" aria-hidden="true"></i> Student
                    </button>
                    <button type="button" class="role-badge role-faculty" data-role="faculty" aria-pressed="false">
                        <i class="fas fa-chalkboard-teacher" aria-hidden="true"></i> Faculty
                    </button>
                    <button type="button" class="role-badge role-hod" data-role="hod" aria-pressed="false">
                        <i class="fas fa-user-tie" aria-hidden="true"></i> HOD
                    </button>
                    <button type="button" class="role-badge role-principal" data-role="principal" aria-pressed="false">
                        <i class="fas fa-user-shield" aria-hidden="true"></i> Principal
                    </button>
                </div>
                
                <div class="form-options">
                    <div class="checkbox-group">
                        <input type="checkbox" id="rememberMe" name="rememberMe">
                        <label for="rememberMe">Remember Me</label>
                    </div>
                    <a href="#" class="forgot-link" id="forgotPassword">Forgot Password?</a>
                </div>
                
                <button type="submit" class="btn btn-primary" aria-live="polite">
                    <span class="btn-text">Login to Platform</span>
                </button>
            </form>
            
            <div class="divider">
                <span>OR</span>
            </div>
            
            <button type="button" class="btn btn-google" id="googleLoginBtn" aria-live="polite">
                <i class="fab fa-google" aria-hidden="true"></i>
                <span class="btn-text">Login with Google</span>
            </button>
            
            <button type="button" class="btn btn-microsoft" id="microsoftLoginBtn" aria-live="polite">
                <i class="fab fa-microsoft" aria-hidden="true"></i>
                <span class="btn-text">Login with Microsoft</span>
            </button>
            
            <p class="register-link">New to Sona Communication? <a href="#" id="registerLink">Create an account</a></p>
            
            <div class="security-notice">
                <i class="fas fa-shield-alt" aria-hidden="true"></i>
                <span>All communications are end-to-end encrypted</span>
            </div>
        </div>
    </div>

    <!-- Registration Modal -->
    <div class="modal" id="registerModal" role="dialog" aria-labelledby="registerModalTitle" aria-modal="true">
        <div class="modal-content">
            <button class="close-btn" id="closeRegister" aria-label="Close registration modal">&times;</button>
            <h2 id="registerModalTitle">Register New User</h2>
            <form id="registerForm" aria-label="Registration form">
                <div class="form-group">
                    <label for="regCollegeId">College ID</label>
                    <div class="input-container">
                        <i class="fas fa-id-card input-icon" aria-hidden="true"></i>
                        <input type="text" id="regCollegeId" required placeholder="e.g., SONA2024001" autocomplete="username">
                    </div>
                </div>
                <div class="form-group">
                    <label for="regEmail">Email Address</label>
                    <div class="input-container">
                        <i class="fas fa-envelope input-icon" aria-hidden="true"></i>
                        <input type="email" id="regEmail" required pattern=".+@sonatech\.ac\.in" placeholder="name@sonatech.ac.in" autocomplete="email">
                    </div>
                </div>
                <div class="form-group">
                    <label for="regPassword">Password</label>
                    <div class="input-container">
                        <i class="fas fa-lock input-icon" aria-hidden="true"></i>
                        <input type="password" id="regPassword" required placeholder="Create a strong password" autocomplete="new-password">
                        <button type="button" class="password-toggle tooltip" id="regPasswordToggle" aria-label="Toggle password visibility">
                            <i class="fas fa-eye" aria-hidden="true"></i>
                            <span class="tooltiptext">Toggle password visibility</span>
                        </button>
                    </div>
                    <div class="password-strength" id="passwordStrength" aria-hidden="true">
                        <div class="password-strength-bar"></div>
                    </div>
                    <div class="password-strength-text" id="passwordStrengthText" aria-live="polite">Password strength</div>
                </div>
                <div class="form-group">
                    <label for="regRole">Role</label>
                    <div class="input-container">
                        <i class="fas fa-user-tag input-icon" aria-hidden="true"></i>
                        <select id="regRole" required>
                            <option value="">Select Your Role</option>
                            <option value="student">Student</option>
                            <option value="faculty">Faculty</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="regDepartment">Department ID</label>
                    <div class="input-container">
                        <i class="fas fa-building input-icon" aria-hidden="true"></i>
                        <input type="number" id="regDepartment" required placeholder="e.g., 101">
                    </div>
                </div>
                <div class="form-group">
                    <label for="regFullName">Full Name</label>
                    <div class="input-container">
                        <i class="fas fa-user input-icon" aria-hidden="true"></i>
                        <input type="text" id="regFullName" required placeholder="Enter your full name" autocomplete="name">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" aria-live="polite">
                    <span class="btn-text">Submit for Approval</span>
                </button>
            </form>
            
            <div class="divider">
                <span>OR</span>
            </div>
            
            <button type="button" class="btn btn-google" id="googleRegisterBtn" aria-live="polite">
                <i class="fab fa-google" aria-hidden="true"></i>
                <span class="btn-text">Register with Google</span>
            </button>
            
            <button type="button" class="btn btn-microsoft" id="microsoftRegisterBtn" aria-live="polite">
                <i class="fab fa-microsoft" aria-hidden="true"></i>
                <span class="btn-text">Register with Microsoft</span>
            </button>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div class="modal" id="forgotModal" role="dialog" aria-labelledby="forgotModalTitle" aria-modal="true">
        <div class="modal-content">
            <button class="close-btn" id="closeForgot" aria-label="Close forgot password modal">&times;</button>
            <h2 id="forgotModalTitle">Reset Your Password</h2>
            <form id="forgotForm" aria-label="Password reset form">
                <div class="form-group">
                    <label for="forgotEmail">Email Address</label>
                    <div class="input-container">
                        <i class="fas fa-envelope input-icon" aria-hidden="true"></i>
                        <input type="email" id="forgotEmail" required placeholder="Enter your registered email" autocomplete="email">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" aria-live="polite">
                    <span class="btn-text">Send Reset Link</span>
                </button>
            </form>
        </div>
    </div>

    <!-- Microsoft Account Setup Modal -->
    <div class="modal" id="microsoftSetupModal" role="dialog" aria-labelledby="microsoftSetupModalTitle" aria-modal="true">
        <div class="modal-content">
            <button class="close-btn" id="closeMicrosoftSetup" aria-label="Close Microsoft setup modal">&times;</button>
            <h2 id="microsoftSetupModalTitle">Complete Your Profile</h2>
            <p class="subtitle" style="margin-bottom: 1.75rem;">Please provide additional information to complete your account setup</p>
            <form id="microsoftSetupForm" aria-label="Microsoft account setup form">
                <div class="form-group">
                    <label for="msCollegeId">College ID</label>
                    <div class="input-container">
                        <i class="fas fa-id-card input-icon" aria-hidden="true"></i>
                        <input type="text" id="msCollegeId" required placeholder="e.g., SONA2024001" autocomplete="username">
                    </div>
                </div>
                <div class="form-group">
                    <label for="msRole">Role</label>
                    <div class="input-container">
                        <i class="fas fa-user-tag input-icon" aria-hidden="true"></i>
                        <select id="msRole" required>
                            <option value="">Select Your Role</option>
                            <option value="student">Student</option>
                            <option value="faculty">Faculty</option>
                            <option value="hod">Head of Department</option>
                            <option value="principal">Principal</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="msDepartment">Department ID</label>
                    <div class="input-container">
                        <i class="fas fa-building input-icon" aria-hidden="true"></i>
                        <input type="number" id="msDepartment" required placeholder="e.g., 101">
                    </div>
                </div>
                <div class="form-group">
                    <label for="msFullName">Full Name</label>
                    <div class="input-container">
                        <i class="fas fa-user input-icon" aria-hidden="true"></i>
                        <input type="text" id="msFullName" required placeholder="Enter your full name" autocomplete="name">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" aria-live="polite">
                    <span class="btn-text">Complete Setup</span>
                </button>
            </form>
        </div>
    </div>

    <!-- Google Account Setup Modal -->
    <div class="modal" id="googleSetupModal" role="dialog" aria-labelledby="googleSetupModalTitle" aria-modal="true">
        <div class="modal-content">
            <button class="close-btn" id="closeGoogleSetup" aria-label="Close Google setup modal">&times;</button>
            <h2 id="googleSetupModalTitle">Complete Your Profile</h2>
            <p class="subtitle" style="margin-bottom: 1.75rem;">Please provide additional information to complete your account setup</p>
            <form id="googleSetupForm" aria-label="Google account setup form">
                <div class="form-group">
                    <label for="googleCollegeId">College ID</label>
                    <div class="input-container">
                        <i class="fas fa-id-card input-icon" aria-hidden="true"></i>
                        <input type="text" id="googleCollegeId" required placeholder="e.g., SONA2024001" autocomplete="username">
                    </div>
                </div>
                <div class="form-group">
                    <label for="googleRole">Role</label>
                    <div class="input-container">
                        <i class="fas fa-user-tag input-icon" aria-hidden="true"></i>
                        <select id="googleRole" required>
                            <option value="">Select Your Role</option>
                            <option value="student">Student</option>
                            <option value="faculty">Faculty</option>
                            <option value="hod">Head of Department</option>
                            <option value="principal">Principal</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="googleDepartment">Department ID</label>
                    <div class="input-container">
                        <i class="fas fa-building input-icon" aria-hidden="true"></i>
                        <input type="number" id="googleDepartment" required placeholder="e.g., 101">
                    </div>
                </div>
                <div class="form-group">
                    <label for="googleFullName">Full Name</label>
                    <div class="input-container">
                        <i class="fas fa-user input-icon" aria-hidden="true"></i>
                        <input type="text" id="googleFullName" required placeholder="Enter your full name" autocomplete="name">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" aria-live="polite">
                    <span class="btn-text">Complete Setup</span>
                </button>
            </form>
        </div>
    </div>

    <div class="notification" id="notification" role="alert" aria-live="assertive"></div>

    <!-- Debug Panel -->
    <div class="debug-panel" id="debugPanel">
        <div>Debug Info:</div>
        <div id="debugContent"></div>
    </div>

    <!-- Sync Button (Admin Only) -->
    <button class="sync-button" id="syncButton">
        <i class="fas fa-sync-alt"></i>
        <span>Sync Microsoft Users</span>
    </button>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <p>&copy; 2025 Sona College of Technology. All rights reserved.</p>
            <p>Made with <i class="fas fa-heart footer-heart"></i> by Krishna</p>
        </div>
    </footer>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAUmR-p_bJ970GK9CevtzgfAm99nvLvSaE",
            authDomain: "sona-da878.firebaseapp.com",
            databaseURL: "https://sona-da878-default-rtdb.firebaseio.com",
            projectId: "sona-da878",
            storageBucket: "sona-da878.firebasestorage.app",
            messagingSenderId: "963825066019",
            appId: "1:963825066019:web:c1a095c0972a8874195196",
            measurementId: "G-ED8CHJSJGH"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Configure Microsoft provider
        const microsoftProvider = new firebase.auth.OAuthProvider('microsoft.com');
        microsoftProvider.setCustomParameters({
            prompt: 'select_account',
            tenant: 'common' // Use your tenant ID if needed
        });

        // DOM Elements
        const elements = {
            loginForm: document.getElementById('loginForm'),
            registerForm: document.getElementById('registerForm'),
            forgotForm: document.getElementById('forgotForm'),
            microsoftSetupForm: document.getElementById('microsoftSetupForm'),
            googleSetupForm: document.getElementById('googleSetupForm'),
            registerModal: document.getElementById('registerModal'),
            forgotModal: document.getElementById('forgotModal'),
            microsoftSetupModal: document.getElementById('microsoftSetupModal'),
            googleSetupModal: document.getElementById('googleSetupModal'),
            passwordToggle: document.getElementById('passwordToggle'),
            regPasswordToggle: document.getElementById('regPasswordToggle'),
            passwordField: document.getElementById('password'),
            regPasswordField: document.getElementById('regPassword'),
            roleBadges: document.querySelectorAll('.role-badge'),
            roleSelect: document.getElementById('role'),
            passwordStrength: document.getElementById('passwordStrength'),
            passwordStrengthText: document.getElementById('passwordStrengthText'),
            notification: document.getElementById('notification'),
            microsoftLoginBtn: document.getElementById('microsoftLoginBtn'),
            microsoftRegisterBtn: document.getElementById('microsoftRegisterBtn'),
            googleLoginBtn: document.getElementById('googleLoginBtn'),
            googleRegisterBtn: document.getElementById('googleRegisterBtn'),
            debugPanel: document.getElementById('debugPanel'),
            debugContent: document.getElementById('debugContent'),
            syncButton: document.getElementById('syncButton')
        };

        // Debug function
        function debug(message) {
            console.log(message);
            if (elements.debugPanel) {
                elements.debugPanel.classList.add('show');
                elements.debugContent.innerHTML += message + '<br>';
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            // Check for remembered user
            checkRememberedUser();
            
            // Setup event listeners
            setupEventListeners();
            
            // Set up authentication state observer
            auth.onAuthStateChanged(user => {
                debug('Auth state changed: ' + (user ? 'User logged in' : 'No user'));
                
                if (user) {
                    // User is signed in
                    const uid = user.uid;
                    debug('User UID: ' + uid);
                    
                    // Get user data from Firestore
                    db.collection('users').doc(uid).get()
                        .then(doc => {
                            if (doc.exists) {
                                const userData = doc.data();
                                debug('User data found: ' + JSON.stringify(userData));
                                
                                // Store user data in localStorage
                                localStorage.setItem('user', JSON.stringify({
                                    uid: uid,
                                    ...userData
                                }));
                                
                                // Redirect to role-based page
                                redirectBasedOnRole(userData.role);
                            } else {
                                debug('No user document found in Firestore');
                                // For admin accounts, create a default user document
                                handleAdminUser(user);
                            }
                        })
                        .catch(error => {
                            console.error("Error getting user data:", error);
                            debug('Error getting user data: ' + error.message);
                            showNotification('Error loading user data', 'error');
                        });
                }
            });
        });

        // Handle admin user creation
        function handleAdminUser(user) {
            const email = user.email;
            let role = '';
            let department = '';
            let collegeId = '';
            
            if (email === 'principal.test@sona.ac.in') {
                role = 'principal';
                department = 'ADMINISTRATION';
                collegeId = 'principal.test';
            } else if (email === 'hod.cse@sona.ac.in') {
                role = 'hod';
                department = 'Computer Science Engineering';
                collegeId = 'hod.cse';
            } else if (email === 'hod.ece@sona.ac.in') {
                role = 'hod';
                department = 'Electronics & Communication Engineering';
                collegeId = 'hod.ece';
            } else if (email === 'faculty.cse01@sona.ac.in') {
                role = 'faculty';
                department = 'Computer Science Engineering';
                collegeId = 'faculty.cse01';
            } else if (email === 'faculty.ece01@sona.ac.in') {
                role = 'faculty';
                department = 'Electronics & Communication Engineering';
                collegeId = 'faculty.ece01';
            } else if (email === 'student.cse.2023e01@sona.ac.in') {
                role = 'student';
                department = 'Computer Science Engineering';
                collegeId = 'student.cse.2023e01';
            } else if (email === 'student.ece.2023001@sona.ac.in') {
                role = 'student';
                department = 'Electronics & Communication Engineering';
                collegeId = 'student.ece.2023001';
            }
            
            if (role) {
                const userData = {
                    collegeId: collegeId,
                    role: role,
                    department: department,
                    name: email.split('@')[0],
                    email: email,
                    authMethod: 'email',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    approved: true
                };
                
                debug('Creating admin user document: ' + JSON.stringify(userData));
                
                db.collection('users').doc(user.uid).set(userData)
                    .then(() => {
                        debug('Admin user document created successfully');
                        localStorage.setItem('user', JSON.stringify({
                            uid: user.uid,
                            ...userData
                        }));
                        redirectBasedOnRole(role);
                    })
                    .catch(error => {
                        console.error('Error creating admin user:', error);
                        debug('Error creating admin user: ' + error.message);
                        showNotification('Error setting up admin account', 'error');
                    });
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Password visibility toggles
            elements.passwordToggle.addEventListener('click', () => togglePasswordVisibility(elements.passwordField, elements.passwordToggle));
            elements.regPasswordToggle.addEventListener('click', () => togglePasswordVisibility(elements.regPasswordField, elements.regPasswordToggle));

            // Role badge selection
            elements.roleBadges.forEach(badge => {
                badge.addEventListener('click', () => selectRoleBadge(badge));
            });

            // Role select dropdown change
            elements.roleSelect.addEventListener('change', () => {
                // Update active badge based on dropdown selection
                const selectedRole = elements.roleSelect.value;
                elements.roleBadges.forEach(badge => {
                    if (badge.getAttribute('data-role') === selectedRole) {
                        badge.classList.add('active');
                        badge.setAttribute('aria-pressed', 'true');
                    } else {
                        badge.classList.remove('active');
                        badge.setAttribute('aria-pressed', 'false');
                    }
                });
            });

            // Password strength indicator
            elements.regPasswordField.addEventListener('input', updatePasswordStrength);

            // Modal handlers
            document.getElementById('registerLink').addEventListener('click', (e) => {
                e.preventDefault();
                openModal(elements.registerModal);
            });

            document.getElementById('closeRegister').addEventListener('click', () => {
                closeModal(elements.registerModal);
            });

            document.getElementById('forgotPassword').addEventListener('click', (e) => {
                e.preventDefault();
                openModal(elements.forgotModal);
            });

            document.getElementById('closeForgot').addEventListener('click', () => {
                closeModal(elements.forgotModal);
            });

            document.getElementById('closeMicrosoftSetup').addEventListener('click', () => {
                closeModal(elements.microsoftSetupModal);
            });

            document.getElementById('closeGoogleSetup').addEventListener('click', () => {
                closeModal(elements.googleSetupModal);
            });

            // Close modals when clicking outside
            [elements.registerModal, elements.forgotModal, elements.microsoftSetupModal, elements.googleSetupModal].forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal(modal);
                    }
                });
            });

            // Form submissions
            elements.loginForm.addEventListener('submit', handleLogin);
            elements.registerForm.addEventListener('submit', handleRegister);
            elements.forgotForm.addEventListener('submit', handleForgotPassword);
            elements.microsoftSetupForm.addEventListener('submit', handleMicrosoftSetup);
            elements.googleSetupForm.addEventListener('submit', handleGoogleSetup);

            // Authentication buttons
            elements.microsoftLoginBtn.addEventListener('click', () => handleMicrosoftAuth(true));
            elements.microsoftRegisterBtn.addEventListener('click', () => handleMicrosoftAuth(false));
            elements.googleLoginBtn.addEventListener('click', () => handleGoogleAuth(true));
            elements.googleRegisterBtn.addEventListener('click', () => handleGoogleAuth(false));
            
            // Sync button
            elements.syncButton.addEventListener('click', syncAllMicrosoftUsers);
        }

        // Toggle password visibility
        function togglePasswordVisibility(passwordField, toggleButton) {
            const type = passwordField.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordField.setAttribute('type', type);
            toggleButton.innerHTML = type === 'password' ? 
                '<i class="fas fa-eye" aria-hidden="true"></i>' : 
                '<i class="fas fa-eye-slash" aria-hidden="true"></i>';
        }

        // Select role badge
        function selectRoleBadge(badge) {
            elements.roleBadges.forEach(b => {
                b.classList.remove('active');
                b.setAttribute('aria-pressed', 'false');
            });
            badge.classList.add('active');
            badge.setAttribute('aria-pressed', 'true');
            elements.roleSelect.value = badge.getAttribute('data-role');
            
            // Add visual feedback
            badge.style.transform = 'scale(0.95)';
            setTimeout(() => {
                badge.style.transform = '';
            }, 100);
        }

        // Update password strength
        function updatePasswordStrength() {
            const password = elements.regPasswordField.value;
            let strength = 0;
            let text = '';
            
            if (password.length >= 8) strength++;
            if (password.match(/[a-z]/) && password.match(/[A-Z]/)) strength++;
            if (password.match(/\d/)) strength++;
            if (password.match(/[^a-zA-Z\d]/)) strength++;
            
            elements.passwordStrength.className = 'password-strength';
            
            if (password.length > 0) {
                if (strength < 2) {
                    elements.passwordStrength.classList.add('weak');
                    text = 'Weak password';
                } else if (strength < 4) {
                    elements.passwordStrength.classList.add('medium');
                    text = 'Medium strength password';
                } else {
                    elements.passwordStrength.classList.add('strong');
                    text = 'Strong password';
                }
            } else {
                text = 'Password strength';
            }
            
            elements.passwordStrengthText.textContent = text;
        }

        // Show notification
        function showNotification(message, type = 'info') {
            elements.notification.textContent = message;
            elements.notification.className = `notification ${type}`;
            elements.notification.classList.add('show');
            
            setTimeout(() => {
                elements.notification.classList.remove('show');
            }, 4000);
        }

        // Modal functions
        function openModal(modal) {
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            // Focus on first input
            const firstInput = modal.querySelector('input');
            if (firstInput) {
                setTimeout(() => firstInput.focus(), 100);
            }
        }

        function closeModal(modal) {
            modal.style.display = 'none';
            document.body.style.overflow = '';
        }

        // Handle Microsoft authentication
        function handleMicrosoftAuth(isLogin) {
            const button = isLogin ? elements.microsoftLoginBtn : elements.microsoftRegisterBtn;
            button.classList.add('btn-loading');
            
            debug('Starting Microsoft authentication...');
            
            auth.signInWithPopup(microsoftProvider)
                .then((result) => {
                    const user = result.user;
                    debug('Microsoft auth successful: ' + user.email);
                    
                    // Get additional user info from Microsoft
                    const credential = result.credential;
                    const accessToken = credential.accessToken;
                    
                    // Fetch user details from Microsoft Graph API
                    fetchMicrosoftUserData(accessToken, user, isLogin);
                })
                .catch((error) => {
                    console.error('Microsoft auth error:', error);
                    debug('Microsoft auth error: ' + error.message);
                    showNotification('Microsoft authentication failed: ' + error.message, 'error');
                    button.classList.remove('btn-loading');
                });
        }

        // Fetch Microsoft user data from Graph API
        function fetchMicrosoftUserData(accessToken, firebaseUser, isLogin) {
            // Microsoft Graph API endpoint for user details
            const graphEndpoint = 'https://graph.microsoft.com/v1.0/me';
            
            fetch(graphEndpoint, {
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Microsoft Graph API error: ${response.status}`);
                }
                return response.json();
            })
            .then(graphData => {
                debug('Microsoft Graph data received: ' + JSON.stringify(graphData));
                
                // Check if user exists in Firestore
                return db.collection('users').doc(firebaseUser.uid).get()
                    .then(doc => {
                        if (doc.exists) {
                            // User exists, update with latest Microsoft data
                            const userData = doc.data();
                            debug('User exists in Firestore, updating data');
                            
                            // Update user document with latest Microsoft data
                            db.collection('users').doc(firebaseUser.uid).update({
                                displayName: graphData.displayName || userData.name,
                                jobTitle: graphData.jobTitle || '',
                                department: graphData.department || userData.department,
                                officeLocation: graphData.officeLocation || '',
                                lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            
                            // Redirect based on role
                            redirectBasedOnRole(userData.role);
                        } else {
                            // User doesn't exist, create new account
                            debug('User does not exist in Firestore, creating new account');
                            
                            // Extract role from Microsoft data
                            const role = determineRoleFromMicrosoftData(graphData);
                            
                            // Create user document
                            const userData = {
                                collegeId: extractCollegeId(graphData),
                                role: role,
                                department: graphData.department || '',
                                name: graphData.displayName || firebaseUser.displayName,
                                email: firebaseUser.email,
                                jobTitle: graphData.jobTitle || '',
                                officeLocation: graphData.officeLocation || '',
                                authMethod: 'microsoft',
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                                approved: true
                            };
                            
                            return db.collection('users').doc(firebaseUser.uid).set(userData)
                                .then(() => {
                                    // If this is a faculty or HOD, fetch their team members
                                    if (role === 'faculty' || role === 'hod') {
                                        fetchTeamMembers(accessToken, firebaseUser.uid, graphData.department);
                                    }
                                    
                                    // Redirect based on role
                                    redirectBasedOnRole(role);
                                });
                        }
                    });
            })
            .catch(error => {
                console.error('Error fetching Microsoft Graph data:', error);
                debug('Microsoft Graph error: ' + error.message);
                showNotification('Error retrieving user details from Microsoft', 'error');
                
                // Fallback: create basic user document
                const fallbackUserData = {
                    collegeId: firebaseUser.email.split('@')[0],
                    role: 'student', // Default fallback role
                    name: firebaseUser.displayName || firebaseUser.email.split('@')[0],
                    email: firebaseUser.email,
                    authMethod: 'microsoft',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    approved: true
                };
                
                db.collection('users').doc(firebaseUser.uid).set(fallbackUserData)
                    .then(() => {
                        redirectBasedOnRole('student');
                    })
                    .catch(err => {
                        console.error('Error creating fallback user:', err);
                        showNotification('Error creating user account', 'error');
                    });
            })
            .finally(() => {
                const button = isLogin ? elements.microsoftLoginBtn : elements.microsoftRegisterBtn;
                button.classList.remove('btn-loading');
            });
        }

        // Determine role from Microsoft data
        function determineRoleFromMicrosoftData(graphData) {
            // Check job title for role determination
            const jobTitle = (graphData.jobTitle || '').toLowerCase();
            
            if (jobTitle.includes('principal')) {
                return 'principal';
            } else if (jobTitle.includes('hod') || jobTitle.includes('head of department')) {
                return 'hod';
            } else if (jobTitle.includes('faculty') || jobTitle.includes('professor') || jobTitle.includes('lecturer')) {
                return 'faculty';
            } else {
                // Default to student if no specific role is identified
                return 'student';
            }
        }

        // Extract college ID from Microsoft data
        function extractCollegeId(graphData) {
            // Try to extract from email first
            if (graphData.mail && graphData.mail.includes('@')) {
                return graphData.mail.split('@')[0];
            }
            
            // Fallback to userPrincipalName
            if (graphData.userPrincipalName && graphData.userPrincipalName.includes('@')) {
                return graphData.userPrincipalName.split('@')[0];
            }
            
            // Last resort: generate from display name
            return (graphData.displayName || '').replace(/\s+/g, '.').toLowerCase();
        }

        // Fetch team members from Microsoft Graph
        function fetchTeamMembers(accessToken, userId, department) {
            // Microsoft Graph API to fetch users in the same department
            const teamEndpoint = `https://graph.microsoft.com/v1.0/users?$filter=department eq '${department}'&$select=id,displayName,mail,jobTitle`;
            
            fetch(teamEndpoint, {
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Error fetching team members: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                debug(`Fetched ${data.value.length} team members for department ${department}`);
                
                // Store team members in Firestore
                const batch = db.batch();
                
                data.value.forEach(member => {
                    // Create a reference for each team member
                    const memberRef = db.collection('users').doc(userId)
                        .collection('teamMembers').doc(member.id);
                    
                    batch.set(memberRef, {
                        name: member.displayName,
                        email: member.mail,
                        jobTitle: member.jobTitle,
                        addedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });
                
                // Commit the batch
                return batch.commit();
            })
            .then(() => {
                debug('Team members saved successfully');
            })
            .catch(error => {
                console.error('Error fetching team members:', error);
                debug('Team members fetch error: ' + error.message);
            });
        }

        // Handle Microsoft setup form
        function handleMicrosoftSetup(e) {
            e.preventDefault();
            const submitBtn = elements.microsoftSetupForm.querySelector('.btn');
            
            // Show loading state
            submitBtn.classList.add('btn-loading');
            
            const collegeId = document.getElementById('msCollegeId').value;
            const role = document.getElementById('msRole').value;
            const department = document.getElementById('msDepartment').value;
            const fullName = document.getElementById('msFullName').value;
            
            // Get current user
            const user = auth.currentUser;
            
            if (user) {
                // Create user object
                const userData = {
                    collegeId,
                    role,
                    department: parseInt(department),
                    name: fullName,
                    email: user.email,
                    authMethod: 'microsoft',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    approved: true
                };
                
                debug('Creating Microsoft user document: ' + JSON.stringify(userData));
                
                // Save user to Firestore
                db.collection('users').doc(user.uid).set(userData)
                    .then(() => {
                        showNotification('Account setup completed successfully!', 'success');
                        closeModal(elements.microsoftSetupModal);
                        elements.microsoftSetupForm.reset();
                        
                        // Redirect based on role
                        redirectBasedOnRole(role);
                    })
                    .catch((error) => {
                        console.error('Error saving user data:', error);
                        debug('Error saving user data: ' + error.message);
                        showNotification('Error saving user data. Please try again.', 'error');
                    })
                    .finally(() => {
                        submitBtn.classList.remove('btn-loading');
                    });
            } else {
                showNotification('Authentication error. Please try again.', 'error');
                submitBtn.classList.remove('btn-loading');
            }
        }

        // Handle Google authentication
        function handleGoogleAuth(isLogin) {
            const button = isLogin ? elements.googleLoginBtn : elements.googleRegisterBtn;
            button.classList.add('btn-loading');
            
            const provider = new firebase.auth.GoogleAuthProvider();
            
            // Add scopes
            provider.addScope('profile');
            provider.addScope('email');
            
            // Set custom parameters for better UX
            provider.setCustomParameters({
                prompt: 'select_account'
            });
            
            debug('Starting Google authentication...');
            
            auth.signInWithPopup(provider)
                .then((result) => {
                    const user = result.user;
                    debug('Google auth successful: ' + user.email);
                    
                    // Check if user exists in Firestore
                    return db.collection('users').doc(user.uid).get()
                        .then(doc => {
                            if (doc.exists) {
                                // User exists, redirect based on role
                                const userData = doc.data();
                                debug('User exists in Firestore, redirecting to: ' + userData.role);
                                redirectBasedOnRole(userData.role);
                            } else {
                                // User doesn't exist, show setup modal
                                debug('User does not exist in Firestore, showing setup modal');
                                openModal(elements.googleSetupModal);
                                document.getElementById('googleFullName').value = user.displayName || '';
                                document.getElementById('googleEmail').value = user.email || '';
                            }
                        });
                })
                .catch((error) => {
                    console.error('Google auth error:', error);
                    debug('Google auth error: ' + error.message);
                    showNotification('Google authentication failed: ' + error.message, 'error');
                })
                .finally(() => {
                    button.classList.remove('btn-loading');
                });
        }

        // Handle Google setup form
        function handleGoogleSetup(e) {
            e.preventDefault();
            const submitBtn = elements.googleSetupForm.querySelector('.btn');
            
            // Show loading state
            submitBtn.classList.add('btn-loading');
            
            const collegeId = document.getElementById('googleCollegeId').value;
            const role = document.getElementById('googleRole').value;
            const department = document.getElementById('googleDepartment').value;
            const fullName = document.getElementById('googleFullName').value;
            
            // Get current user
            const user = auth.currentUser;
            
            if (user) {
                // Create user object
                const userData = {
                    collegeId,
                    role,
                    department: parseInt(department),
                    name: fullName,
                    email: user.email,
                    authMethod: 'google',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    approved: true
                };
                
                debug('Creating Google user document: ' + JSON.stringify(userData));
                
                // Save user to Firestore
                db.collection('users').doc(user.uid).set(userData)
                    .then(() => {
                        showNotification('Account setup completed successfully!', 'success');
                        closeModal(elements.googleSetupModal);
                        elements.googleSetupForm.reset();
                        
                        // Redirect based on role
                        redirectBasedOnRole(role);
                    })
                    .catch((error) => {
                        console.error('Error saving user data:', error);
                        debug('Error saving user data: ' + error.message);
                        showNotification('Error saving user data. Please try again.', 'error');
                    })
                    .finally(() => {
                        submitBtn.classList.remove('btn-loading');
                    });
            } else {
                showNotification('Authentication error. Please try again.', 'error');
                submitBtn.classList.remove('btn-loading');
            }
        }

        // Handle login form submission
        function handleLogin(e) {
            e.preventDefault();
            const collegeId = document.getElementById('collegeId').value;
            const password = document.getElementById('password').value;
            const role = document.getElementById('role').value;
            const submitBtn = elements.loginForm.querySelector('.btn');

            debug('Login attempt: ' + collegeId + ', role: ' + role);

            // Show loading state
            submitBtn.classList.add('btn-loading');
            
            // For admin accounts, use direct authentication
            if (collegeId === 'principal.test' && role === 'principal') {
                debug('Attempting principal login');
                auth.signInWithEmailAndPassword('principal.test@sona.ac.in', password)
                    .then(() => {
                        showNotification(`Welcome back, Principal!`, 'success');
                        
                        // Remember user if checkbox is checked
                        if (document.getElementById('rememberMe').checked) {
                            localStorage.setItem('rememberedUser', JSON.stringify({
                                collegeId,
                                role
                            }));
                        }
                    })
                    .catch((error) => {
                        console.error('Login error:', error);
                        debug('Principal login error: ' + error.message);
                        submitBtn.classList.remove('btn-loading');
                        showNotification('Invalid credentials. Please try again.', 'error');
                    });
                return;
            }
            
            if (collegeId === 'hod.cse' && role === 'hod') {
                debug('Attempting HOD CSE login');
                auth.signInWithEmailAndPassword('hod.cse@sona.ac.in', password)
                    .then(() => {
                        showNotification(`Welcome back, HOD CSE!`, 'success');
                        
                        // Remember user if checkbox is checked
                        if (document.getElementById('rememberMe').checked) {
                            localStorage.setItem('rememberedUser', JSON.stringify({
                                collegeId,
                                role
                            }));
                        }
                    })
                    .catch((error) => {
                        console.error('Login error:', error);
                        debug('HOD CSE login error: ' + error.message);
                        submitBtn.classList.remove('btn-loading');
                        showNotification('Invalid credentials. Please try again.', 'error');
                    });
                return;
            }
            
            if (collegeId === 'hod.ece' && role === 'hod') {
                debug('Attempting HOD ECE login');
                auth.signInWithEmailAndPassword('hod.ece@sona.ac.in', password)
                    .then(() => {
                        showNotification(`Welcome back, HOD ECE!`, 'success');
                        
                        // Remember user if checkbox is checked
                        if (document.getElementById('rememberMe').checked) {
                            localStorage.setItem('rememberedUser', JSON.stringify({
                                collegeId,
                                role
                            }));
                        }
                    })
                    .catch((error) => {
                        console.error('Login error:', error);
                        debug('HOD ECE login error: ' + error.message);
                        submitBtn.classList.remove('btn-loading');
                        showNotification('Invalid credentials. Please try again.', 'error');
                    });
                return;
            }
            
            // Query Firestore for user with this collegeId
            debug('Querying Firestore for user: ' + collegeId + ', role: ' + role);
            db.collection('users')
                .where('collegeId', '==', collegeId)
                .where('role', '==', role)
                .limit(1)
                .get()
                .then(querySnapshot => {
                    if (querySnapshot.empty) {
                        // No user found
                        debug('No user found in Firestore');
                        submitBtn.classList.remove('btn-loading');
                        showNotification('Invalid credentials. Please try again.', 'error');
                        return;
                    }
                    
                    const userDoc = querySnapshot.docs[0];
                    const userData = userDoc.data();
                    
                    debug('User found in Firestore: ' + JSON.stringify(userData));
                    
                    // Get email from user data
                    const email = userData.email;
                    
                    // Sign in with email and password
                    return auth.signInWithEmailAndPassword(email, password);
                })
                .then((userCredential) => {
                    // Login successful
                    debug('Login successful');
                    showNotification(`Welcome back, ${collegeId}!`, 'success');
                    
                    // Remember user if checkbox is checked
                    if (document.getElementById('rememberMe').checked) {
                        localStorage.setItem('rememberedUser', JSON.stringify({
                            collegeId,
                            role
                        }));
                    }
                    
                    // Redirect will be handled by auth state observer
                })
                .catch((error) => {
                    console.error('Login error:', error);
                    debug('Login error: ' + error.message);
                    submitBtn.classList.remove('btn-loading');
                    
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                        showNotification('Invalid credentials. Please try again.', 'error');
                    } else {
                        showNotification('Login failed. Please try again.', 'error');
                    }
                });
        }

        // Handle registration form submission
        function handleRegister(e) {
            e.preventDefault();
            const submitBtn = elements.registerForm.querySelector('.btn');
            
            // Show loading state
            submitBtn.classList.add('btn-loading');
            
            const collegeId = document.getElementById('regCollegeId').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const role = document.getElementById('regRole').value;
            const department = parseInt(document.getElementById('regDepartment').value);
            const fullName = document.getElementById('regFullName').value;
            
            // Create user with email and password
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    
                    // Create user object
                    const userData = {
                        collegeId,
                        role,
                        department,
                        name: fullName,
                        email,
                        authMethod: 'email',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        approved: false // Default to not approved
                    };
                    
                    // Save user to Firestore
                    return db.collection('users').doc(user.uid).set(userData);
                })
                .then(() => {
                    showNotification('Registration submitted for approval. You will receive an email once approved.', 'success');
                    closeModal(elements.registerModal);
                    elements.registerForm.reset();
                    elements.passwordStrength.className = 'password-strength';
                    elements.passwordStrengthText.textContent = 'Password strength';
                    
                    // Sign out the user until they're approved
                    auth.signOut();
                })
                .catch((error) => {
                    console.error('Registration error:', error);
                    
                    if (error.code === 'auth/email-already-in-use') {
                        showNotification('Email already in use. Please use a different email.', 'error');
                    } else if (error.code === 'auth/weak-password') {
                        showNotification('Password is too weak. Please use a stronger password.', 'error');
                    } else {
                        showNotification('Registration failed. Please try again.', 'error');
                    }
                })
                .finally(() => {
                    submitBtn.classList.remove('btn-loading');
                });
        }

        // Handle forgot password form submission
        function handleForgotPassword(e) {
            e.preventDefault();
            const submitBtn = elements.forgotForm.querySelector('.btn');
            
            // Show loading state
            submitBtn.classList.add('btn-loading');
            
            const email = document.getElementById('forgotEmail').value;
            
            // Send password reset email
            auth.sendPasswordResetEmail(email)
                .then(() => {
                    showNotification('Password reset link sent to your email.', 'info');
                    closeModal(elements.forgotModal);
                    elements.forgotForm.reset();
                })
                .catch((error) => {
                    console.error('Password reset error:', error);
                    
                    if (error.code === 'auth/user-not-found') {
                        showNotification('No user found with this email address.', 'error');
                    } else {
                        showNotification('Failed to send reset link. Please try again.', 'error');
                    }
                })
                .finally(() => {
                    submitBtn.classList.remove('btn-loading');
                });
        }

        // Check for remembered user
        function checkRememberedUser() {
            const rememberedUser = localStorage.getItem('rememberedUser');
            if (rememberedUser) {
                const user = JSON.parse(rememberedUser);
                document.getElementById('collegeId').value = user.collegeId;
                document.getElementById('role').value = user.role;
                document.getElementById('rememberMe').checked = true;
                
                // Activate the corresponding role badge
                elements.roleBadges.forEach(badge => {
                    if (badge.getAttribute('data-role') === user.role) {
                        badge.classList.add('active');
                        badge.setAttribute('aria-pressed', 'true');
                    }
                });
            }
        }

        // Redirect based on user role
        function redirectBasedOnRole(role) {
            debug('Redirecting based on role: ' + role);
            
            // Add a slight delay to allow notification to be seen
            setTimeout(() => {
                let targetUrl = '';
                
                switch(role) {
                    case 'student':
                        targetUrl = 'student.html';
                        break;
                    case 'faculty':
                        targetUrl = 'faculty.html';
                        break;
                    case 'hod':
                        targetUrl = 'hod.html';
                        break;
                    case 'principal':
                        targetUrl = 'principal.html';
                        break;
                    default:
                        targetUrl = 'dashboard.html';
                }
                
                debug('Redirecting to: ' + targetUrl);
                
                // Redirect directly without checking if the page exists
                // This is for demo purposes - in production, you would want to ensure the pages exist
                window.location.href = targetUrl;
            }, 1000);
        }

        // Sync all Microsoft users (admin only)
        function syncAllMicrosoftUsers() {
            if (!auth.currentUser) {
                showNotification('Please log in first', 'error');
                return;
            }
            
            // Check if current user is principal
            db.collection('users').doc(auth.currentUser.uid).get()
                .then(doc => {
                    if (!doc.exists || doc.data().role !== 'principal') {
                        showNotification('Only principals can sync users', 'error');
                        return;
                    }
                    
                    showNotification('Starting Microsoft user sync...', 'info');
                    
                    // Simulate API call delay
                    setTimeout(() => {
                        showNotification('Microsoft user sync completed successfully', 'success');
                        
                        // In a real implementation, you would:
                        // 1. Use Microsoft Graph API with admin credentials to fetch all users
                        // 2. Process each user and create/update Firebase auth and Firestore documents
                        // 3. Handle pagination for large user sets
                        // 4. Implement proper error handling and logging
                    }, 3000);
                });
        }

        // Handle keyboard navigation
        document.addEventListener('keydown', (e) => {
            // Close modals with Escape key
            if (e.key === 'Escape') {
                [elements.registerModal, elements.forgotModal, elements.microsoftSetupModal, elements.googleSetupModal].forEach(modal => {
                    if (modal.style.display === 'flex') {
                        closeModal(modal);
                    }
                });
            }
            
            // Toggle debug panel with Ctrl+D
            if (e.ctrlKey && e.key === 'd') {
                e.preventDefault();
                elements.debugPanel.classList.toggle('show');
            }
        });

        // Check if current user is admin to show sync button
        auth.onAuthStateChanged(user => {
            if (user) {
                db.collection('users').doc(user.uid).get()
                    .then(doc => {
                        if (doc.exists && doc.data().role === 'principal') {
                            elements.syncButton.classList.add('show');
                        }
                    });
            }
        });
    </script>
</body>
</html>
